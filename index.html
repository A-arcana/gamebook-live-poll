<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <title>LDVELH Facebook Poll Maker</title>
	
	<style>
	body{font-family: arial;}
	
	#display-options li a { 
		cursor: pointer; 
		float: left;
		margin-left: -45px;
		font-weight: bold;
		color: red;
	}
	
	#display-options-add { 
		cursor: pointer; 
		float: left;
		margin: 0 35px 0 10px;
		font-weight: bold;
		color: green;
	}
	</style>

    <script type="text/javascript">
        function setCookie(key, value, expiry) {
            var expires = new Date();
            if (!expiry) expiry = 365;
            expires.setTime(expires.getTime() + (expiry * 24 * 60 * 60 * 1000));
            document.cookie = key + '=' + value + ';expires=' + expires.toUTCString();
        }

        function getCookie(key) {
            var keyValue = document.cookie.match('(^|;) ?' + key + '=([^;]*)(;|$)');
            return keyValue ? keyValue[2] : null;
        }

        function eraseCookie(key) {
            var keyValue = getCookie(key);
            setCookie(key, keyValue, '-1');
        }

    </script>
    <script>
        var app = {
            config: JSON.parse(getCookie('ldvelh-app')) || {
                liveId: '',
                tsv: '',
                cols: {
                    colId: 1,
                    colQuestion: 2,
                    colOption: 3
                },
				bookNo: '',
				lastNo: ''
            },
            lines: {},
			pictureTimeout:{}
        };

        $(document).ready(function () {
            $.ajaxSetup({ cache: true });
            $.getScript('https://connect.facebook.net/en_US/sdk.js', function () {
                FB.init({
                    appId: '360035658287515',
                    autoLogAppEvents: true,
                    xfbml: true,
                    version: 'v6.0'
                });

                fbConnect(true)
                setInterval(fbConnect, 20*60*1000);

                setTimeout(function () { if (app.config.tsv) readFile(); }, 1000);
            });

            $('#live-id').val(app.config.liveId);
            $('#book-no').val(app.config.bookNo);
            $('#last-no').val(app.config.lastNo);
            $('#tsv').val(app.config.tsv);
            $('#colId').val(app.config.cols.colId);
            $('#colQuestion').val(app.config.cols.colQuestion);
            $('#colOption').val(app.config.cols.colOption);
        });

        function fbConnect(tryConnectPoll) {
			app.config.bookNo = $('#book-no').val();
            app.config.liveId = $('#live-id').val();
            FB.getLoginStatus(function (response) {
                fbError(response);
                if (response && response.status == "connected") {
                    app.accessToken = response.authResponse.accessToken;
                    setCookie('ldvelh-app', JSON.stringify(app.config));
                    if (tryConnectPoll && app.config.liveId) connect();
                }
                else {
                    FB.login(function (response) {
                        fbError(response);
                        if (response.status === 'connected') {
                            app.accessToken = response.authResponse.accessToken;
                            setCookie('ldvelh-app', JSON.stringify(app.config));
                            if (tryConnectPoll && app.config.liveId) connect();
                        }
                    }, { scope: 'publish_video,manage_pages,publish_pages' });
                }
            }, true);
        }

        function fbError(response) {
            if (!response) {
                $('#error').show();
                $('#error').html($('#error').html() + "<hr/> Response is null");
            }
            else if (response.error) {
                $('#error').show();
                $('#error').html($('#error').html() + "<hr/>" + response.error.message);
            }
            else {
                $('#error').hide();
                $('#error').html("<h6>Errors</h6>");
            }
        }

        function connect() {
            app.config.liveId = $('#live-id').val();
            setCookie('ldvelh-app', JSON.stringify(app.config));

            $('#live-id').css("color", "#090");

            FB.api('/' + app.config.liveId + '/polls?access_token=' + app.accessToken, fbError);
        }

        function readFile() {
            app.config.tsv = $('#tsv').val();
            app.config.cols.colId = $('#colId').val();
            app.config.cols.colQuestion = $('#colQuestion').val();
            app.config.cols.colOption = $('#colOption').val();
			app.config.lastNo = $('#last-no').val();
            setCookie('ldvelh-app', JSON.stringify(app.config));

            $('#question').children().remove();
            $('#question').append("<option value='none'>Choose...</option>");
            $.get(app.config.tsv, function (data) {
                app.lines = {};
				for(i = 1; i <= parseInt(app.config.lastNo); i++){
					app.lines[i+""] = {
						question: i+"",
						options: [],
						picture: {small: null, large: null}
					}
				}
                var lines = data.split("\n");
                for (var i in lines) {
                    if (i == 0) continue;
                    var cols = lines[i].replace("\r", "").split("\t");
                    var section = cols[app.config.cols.colId] + "";
                    var question = cols[app.config.cols.colQuestion] + "";
                    var str = cols[app.config.cols.colOption];
					if(str && app.lines[section]){
						app.lines[section].options.push(str.charAt(0).toUpperCase() + str.slice(1));
					}
                }
				for(let i in app.lines){
					let line = app.lines[i];
					$('#question').append("<option value='"+i+"'>"+line.question+(line.options.length > 0 ? " [poll]":"")+"</option>");
					$.get('get-html?url=https://www.projectaon.org/en/xhtml/lw/'+app.config.bookNo+'/sect'+i+'.htm',
						function(data){
							var htmlDoc = $((new DOMParser()).parseFromString(data, "text/xml").documentElement);
							if(htmlDoc.find('img[alt="[illustration]"]').length > 0){
								line.picture.small = 
									htmlDoc
										.find('img[alt="[illustration]"]')[0]
										.outerHTML
										.replace("src=\"", "src=\"https://www.projectaon.org/en/xhtml/lw/"+app.config.bookNo+"/");
							}
							if(htmlDoc.find('img[alt=illustration]').length > 0){
								line.picture.large =
									htmlDoc
										.find('img[alt=illustration]')[0]
										.outerHTML
										.replace("src=\"", "src=\"https://www.projectaon.org/en/xhtml/lw/"+app.config.bookNo+"/");
							}
							
							if(line.picture.large || line.picture.small){
								$('#question option[value='+i+']').css("background-color", "lightblue");
							}
						}
					);
				}
				
                $('#tsv').css("color", "#090");
                $('#question').val('none');
                $('#question').focus();
            });
            display();
        }

        function display() {
            var section = $('#question').val();
            $('#display-options').html("");
            $('#display-pic').html("");
            $('#display-smallpic').html("");
            $('#display-question').text("");
            
			if (section && section != "none") {
				var question = app.lines[section].question;
                $('#display-question').text(question);
                for (var i in app.lines[section].options) {
					var $opt = $("<li>" + app.lines[section].options[i] + " <a onclick='deleteOpt(\""+section+"\", "+i+")'>X</a></li>");
                    $('#display-options').append($opt);
                }
				$('#display-smallpic').html(app.lines[section].picture.small);
				$('#display-pic').html(app.lines[section].picture.large);
            }
        }
		
		function deleteOpt(section, option){
			app.lines[section].options.splice(option, 1);
			if( app.lines[section].options.length === 0 ){
				$('#question option[value='+section+']').text($('#question option[value='+section+']').text().replace(" [poll]", ""));
			}
			display();
		}
		function addOpt(){
			var section = $('#question').val();
			var option = $('#option-add').val().trim();
			option = option.charAt(0).toUpperCase() + option.slice(1)
			if( app.lines[section].options.length === 0 ){
				$('#question option[value='+section+']').text($('#question option[value='+section+']').text()+" [poll]");
			}
			app.lines[section].options.push(option);
			display();
		}

        function poll() {
            var question = app.lines[$('#question').val()];
            $('#question').val('none');
            $('#question').focus();
            FB.api('/' + app.config.liveId + '/polls', 'post', question, function (response) {
                fbError(response);

                if (!response || !response.id) return;
				
				let item = null;
				$.get('/slobs/scenes/Live Scene',
				scene=>{
					if(scene){
						item = scene.nodes.find(n=>n.name=='countdown');
						$.get('/slobs/set-visibility/"'+item.sceneId+'","'+item.id+'","'+item.sourceId+'"/true');
					}
				});
                var pollId = response.id;
                setTimeout(function () {
                    FB.api('/' + pollId, 'post', { action: 'SHOW_RESULTS', access_token: app.accessToken }, fbError);
						$.get('/slobs/set-visibility/"'+item.sceneId+'","'+item.id+'","'+item.sourceId+'"/false');

                    setTimeout(function () {
                        FB.api('/' + pollId, 'post', { action: 'CLOSE', access_token: app.accessToken }, fbError);
                    }, 30 * 1000);
                }, 60 * 1000);
            });
            $('#display-options').html("");
            $('#display-pic').html("");
            $('#display-smallpic').html("");
            $('#display-question').text("");
        }
		
		function picture(){
            $('#question').focus();
			var src = $('#display-pic img').attr('src');
			var placeholder = "placeholder";
			if(!src){
				src = $('#display-smallpic img').attr('src');
				placeholder = "small-placeholder";
			}
			if(src){
				src = encodeURIComponent(src);
				$.get('/slobs/scenes/Live Scene',
				scene=>{
					if(scene){
						var item = scene.nodes.find(n=>n.name==placeholder);
						$.get('/slobs/set-source/'+item.sourceId+'/'+src);
						$.get('/slobs/set-visibility/"'+item.sceneId+'","'+item.id+'","'+item.sourceId+'"/true');
						if(app.pictureTimeout[placeholder]){
							clearTimeout(app.pictureTimeout[placeholder]);
						}
						app.pictureTimeout[placeholder] = setTimeout(()=>$.get('/slobs/set-visibility/"'+item.sceneId+'","'+item.id+'","'+item.sourceId+'"/false'), placeholder == "placeholder" ? 50000 : 20000);
					}
				});
			}
		}
    </script>
</head>
<body>
    Live Id : <input type="text" id="live-id" /> <button onclick="fbConnect()">Connect</button>
    <br />
    Book no : <input type="text" id="book-no" />
	<br/>
    <br />
    TSV file name : <input type="text" id="tsv" />
	<br/>
	Last no : <input type="text" id="last-no" />
    <br />
    Id Col <input type="number" id="colId" value="1" min="0" max="30"> &bull;
    Question Col <input type="number" id="colQuestion" value="2" min="0" max="30"> &bull;
    Option Col <input type="number" id="colOption" value="3" min="0" max="30">
    <br />
    <button onclick="readFile()">Use</button>
    <br />
    <hr />
    <br />
    Section : <select id="question" onchange="display()"></select>
    <button onclick="poll()">Poll</button><button onclick="picture()">Picture</button>
    <br />
    <hr />
    <br />
    <div style="border: 1px solid grey; background: #EEE; padding: 15px;">
        Display Question : <b id="display-question"></b>
        <br />
        Options :
        <ol style="margin: 0px 15px" id="display-options"></ol>
		<a onclick="addOpt()" id="display-options-add">+</a> <input type="text" id="option-add">
		<br/>
		<div id="display-pic"></div>
		<div id="display-smallpic"></div>
    </div>
    <div id="error" style="border: 1px solid #800; background: #FEE; padding: 15px; display: none; color: #700;">
        <h6>Errors</h6>
    </div>
    <br />
</body>
